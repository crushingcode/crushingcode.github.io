<!DOCTYPE html>
<html lang="en-us">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  	<meta property="og:title" content=" Is your Android Library, Lifecycle-Aware? &middot;  Crushing C.O.D.E" />
  	<meta property="og:site_name" content="Crushing C.O.D.E" />
  	<meta property="og:url" content="https://crushingcode.github.io/is-your-android-library-lifecycle-aware/" />

    
  	<meta property="og:type" content="article" />

    <meta property="og:article:published_time" content="2017-09-17T10:54:24&#43;02:00" />

    
    <meta property="og:article:tag" content="android" />
    
    <meta property="og:article:tag" content="library" />
    
    <meta property="og:article:tag" content="lifecyle" />
    
    

  <title>
     Is your Android Library, Lifecycle-Aware? &middot;  Crushing C.O.D.E
  </title>

    <meta name="description" content="There are two ways to write error-free programs; only the third one works
Nishant Srivastava" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://crushingcode.github.io/images/favicon.ico">
	  <link rel="apple-touch-icon" href="https://crushingcode.github.io/images/apple-touch-icon.png" />

    <link rel="stylesheet" type="text/css" href="https://crushingcode.github.io/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="https://crushingcode.github.io/css/nav.css" />
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:400,700" />


    
      
          <link href="https://crushingcode.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Crushing C.O.D.E" />
      
      
    
    <meta name="generator" content="Hugo 0.51" />

    <link rel="canonical" href="https://crushingcode.github.io/is-your-android-library-lifecycle-aware/" />

    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-53824796-3', 'auto');
      ga('send', 'pageview');

    </script>
    

    
</head>
<body class="nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        

        
            
            <li class="nav-opened" role="presentation">
              <a href="https://crushingcode.github.io/">Home</a>
            </li>
        
            <b> About Me</b>
            <li class="nav-opened" role="presentation">
              <a href="https://github.com/nisrulz/nisrulz.github.io#nishant-srivastava"> Portfolio</a>
            </li>
        
            <b>Follow me üöÄ<b>
            <li class="nav-opened" role="presentation">
              <a href="https://github.com/nisrulz">Github</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
              <a href="https://twitter.com/nisrulz">Twitter</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
              <a href="https://speakerdeck.com/nisrulz">SpeakerDeck</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
              <a href="https://android-arsenal.com/user/nisrulz">Android Arsenal</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
              <a href="http://stackoverflow.com/users/2745762/radix">Stackoverflow</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
              <a href="https://dribbble.com/nisrulz">Dribbble</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
              <a href="https://www.behance.net/nisrulz">Behance</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
              <a href="https://codepen.io/nisrulz/">Codepen</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
              <a href="https://www.quora.com/profile/Nishant-Rulez">Quora</a>
            </li>
        
            <b>Like my work? ‚ò∫Ô∏è</b>
            <li class="nav-opened" role="presentation">
              <a href="https://www.paypal.me/nisrulz/5">Buy me a Coffee</a>
            </li>
        
            <b>Contact Me ‚úâÔ∏è</b>
            <li class="nav-opened" role="presentation">
              <a href="mailto:nisrulz@gmail.com?Subject=Heyo%20CodeCrusher"> Mail</a>
            </li>
        
    </ul>

    
    <a class="subscribe-button icon-feed" href="https://crushingcode.github.io/index.xml">Subscribe</a>
    
</div>
<span class="nav-cover"></span>


 <div class="site-wrapper">




<header class="main-header post-head no-cover">
  <nav class="main-nav clearfix">


  
      <a class="blog-logo" href="https://crushingcode.github.io/"><img src="https://crushingcode.github.io/images/author.jpg" alt="Home" /></a>
  
  
      <a class="menu-button" href="#"><span class="burger">&#9776;</span><span class="word">Menu</span></a>
  
  </nav>
</header>



<main class="content" role="main">




  <article class="post post">

    <header class="post-header">
        <h1 class="post-title">Is your Android Library, Lifecycle-Aware?</h1>
        <small></small>

        <section class="post-meta">
        
        
        
            
            
        

        
            Nishant Srivastava
        
          <time class="post-date" datetime="2017-09-17T10:54:24&#43;02:00">
            Sep 17, 2017
          </time>
        
         
          <span class="post-tag small"><a href="https://crushingcode.github.io/tags/android/">#android</a></span>
         
          <span class="post-tag small"><a href="https://crushingcode.github.io/tags/library/">#library</a></span>
         
          <span class="post-tag small"><a href="https://crushingcode.github.io/tags/lifecyle/">#lifecyle</a></span>
         
        </section>
    </header>

    <section class="post-content">
      <br/>
      

<p><img src="https://crushingcode.github.io/images/posts/is-your-android-library-lifecycle-aware/header.png" alt="header" /></p>

<p><strong>Lifecycle events in Android.</strong></p>

<p>It has been a pain point for Android developers all over the world. It is no brainer that, most of the times the main cause of a memory leak in the codebase is because an invalid state is accessed which is out of sync with the lifecycle of the activity/fragment of the app. What this means is that as an Android Developer you are forced to put up a lot of checks in place, making sure that your code state is in sync with the lifecycle of the Activity/Fragment.</p>

<p>Things start to get a bit more messy when that is something you expect from others to do, which is the case when you are an Android Library Developer. As an android library developer, you need other app developers to conform to unregistering callbacks/call cleanup methods or specific functions to re-initialize at certain points in the lifecycle of Activity/Fragment.i.e onDestroy(), onResume(), onCreate(), etc.</p>

<p>Now that is a lot to expect and ask for. We all know developers tend to avoid going through documentations (..to build features quickly and achieve deadlines, obviously üòÖ ). So what that means is sometimes the cleanup part is missed or not understood quite properly for them to put in the right places in code. For example, if an <code>Activity</code> receives a callback after it‚Äôs been stopped, then it‚Äôs pretty likely that your app is going to crash due to memory leak. Unregistering the callback is right before the Activity is destroyed is what is the needed, which is possible if the app developer calls the <code>cleanup()</code> method from your android library, but it is expected of them. You cannot make sure that they will conform to it.</p>

<h3 id="well-that-is-a-problem-so-what-is-the-solution">Well that is a problem, so what is the solution?</h3>

<p>The solution is to make your android library <strong><em>Lifecycle-Aware</em></strong>. Making android library aware of the states of the lifecycle of Activity/Fragment gives us, the Android library developers greater control over making sure that callbacks are unregistered and calls to cleanup methods or re-initialization happens at the right state in the lifecycle of Activity/Fragment. At the same time it means less dependence on app developer to conform to putting more code and checks in their app to handle the states of your android library. <strong><em>Sounds like a win-win for both, eh!</em></strong> üòé</p>

<h3 id="but-how-do-we-make-our-library-code-lifecycle-aware">But how do we make our library code Lifecycle Aware¬†?</h3>

<h4 id="enter-lifecycle-arch-components">Enter, Lifecycle Arch Components!</h4>

<p><a href="https://developer.android.com/topic/libraries/architecture/lifecycle.html">Lifecycle Arch Components</a> are a new set of lifecycle-aware components that can track the lifecycle of an activity or fragment, and adjust their behavior accordingly.</p>

<p>They are created by good folks at Google, were introduced at Google I/O 2017 and are currently in <code>beta</code> stage. Being in <code>beta</code> does not mean they aren‚Äôt ready. They seem to be the way most people are going to be moving forward in the near future as the library itself becomes stable. But we can get on the band wagon right now, as they are fairly ready.</p>

<blockquote>
<p>Update: <em>Core lifecycle artifacts (runtime, common) have reached stable version <code>v1.0.0</code>. The lifecycle compiler and extensions are now at version <code>v1.0.0-beta1</code></em></p>
</blockquote>

<p>Without taking much time, lets jump right into understanding how to wire these lifecycle components for your own android library‚Ä¶</p>

<p>I will be using a simple example to demonstrate the wiring up process, which is available as a completely functional example app on github <a href="https://github.com/nisrulz/android-examples/tree/develop/LifeCycleCompForLib">here</a>.</p>

<p>Lets start by creating a new app. Once done, you can add a new library module</p>

<p><img src="https://crushingcode.github.io/images/posts/is-your-android-library-lifecycle-aware/p1.jpeg" alt="p1" /></p>

<p>Your folder structure should look like the below</p>

<p><img src="https://crushingcode.github.io/images/posts/is-your-android-library-lifecycle-aware/p2.jpeg" alt="p2" /></p>

<p>Next add this <code>awesomelib</code> module as a dependency to the <code>app</code> module, so that the <code>app</code> module has access to the public classes contained by the <code>awesomelib</code> library module. To do that add the below to the <code>build.gradle</code> of the <code>app</code> module.</p>

<pre><code class="language-gradle">implementation project(':awesomelib')
</code></pre>

<p>Next you want to add a class to your <code>awesomelib</code> library module. I created mine named as <code>AwesomeMainLib</code>¬†. This class is just to showcase the code for library which will be referenced in the <code>app</code> module later on. For simplicity sake, lets make <code>AwesomeMainLib</code> class a singleton. The code in that case would look like below</p>

<script src="https://gist.github.com/nisrulz/18790c977886236404b0f5ddae68910e.js"></script>

<p>and in your <code>app</code> module you would call <code>init()</code> method via <code>AwesomeLibMain.getInstance().init()</code> in <code>onCreate()</code> and <code>cleanup()</code> method via <code>AwesomeLibMain.getInstance().cleanup()</code> in <code>onDestroy()</code> respectively. Here is the code of <code>MainActivity.java</code> class in <code>app</code> module</p>

<script src="https://gist.github.com/nisrulz/4f40bc62018171fbee8f19db7d40d2e1.js"></script>

<p>But thats not the point here, right! We do not want the app developer to be calling these themselves. Also what happens if you want to trigger more methods at specific points in lifecycle of Activity/Fragment? The dependence on app developer increases by many folds and expecting them to do everything right is a like a chink in the armour.</p>

<p>Well let us solve this situation by integrating with Lifecycle Arch Components.</p>

<p>The first thing we need to do is add the required dependencies to <code>build.gradle</code> to each module.</p>

<p>Add the below to the <code>build.gradle</code> for <code>awesomelib</code> module</p>

<pre><code class="language-gradle">implementation &quot;android.arch.lifecycle:runtime:1.0.0&quot;
annotationProcessor &quot;android.arch.lifecycle:compiler:1.0.0-beta1&quot;
</code></pre>

<p>and add the below to the <code>build.gradle</code> for <code>app</code> module</p>

<pre><code class="language-gradle">implementation &quot;com.android.support:appcompat-v7:26.1.0&quot;
</code></pre>

<blockquote>
<p>Note: We are using the latest <a href="https://developer.android.com/topic/libraries/support-library/revisions.html#26-1-0">support lib v26.1.0</a>¬†, which now has AppCompatActivity implementing <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleOwner.html">LifecycleOwner</a> interface from <a href="https://developer.android.com/topic/libraries/architecture/index.html">Architecture Components</a>. More about this, later in the post. For now just know you need support lib <code>v26.1.0</code></p>
</blockquote>

<p>‚Ä¶ that done, sync your project.</p>

<p>Now is the time for us to integrate Lifecycle Arch Components into our android library module, <code>awesomelib</code></p>

<p>We start by first implementing <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleObserver.html">LifecyleObserver</a> class in our <code>AwesomeLibMain</code> class.</p>

<blockquote>
<p><em><strong>From android official docs</strong>: LifecycleObserver is an interface which does not have any methods, instead, relies on <a href="https://developer.android.com/reference/android/arch/lifecycle/OnLifecycleEvent.html">OnLifecycleEvent</a> annotated methods to mark the class for lifecycle events.</em></p>
</blockquote>

<p><strong><em>Now comes the magic</em></strong>. Once you have integrated Lifecycle Arch components, you have access to annotations which correspond to lifecycle events of Activity/Fragment such as</p>

<pre><code class="language-java">@OnLifecycleEvent(Lifecycle.Event.ON_CREATE)
or 
@OnLifecycleEvent(Lifecycle.Event.ON_DESTROY)
..and so on
</code></pre>

<p>Once you annotate the right method with the specific annotation, that method would be triggered at the specified lifecycle event state, during the execution of Activity/Fragment.</p>

<p>Lets have a look at what our <code>AwesomeLibMain</code> class look, after we have annotated the methods</p>

<script src="https://gist.github.com/nisrulz/cc9e23e3c9411a0f147cdc6e04cfa830.js"></script>

<p>as you can see I added more methods and annotated them to get triggered at specific lifecycle event state.</p>

<p>But we are not done here yet. This just tells which method will be triggered when a specific lifecycle event state is reached for the Activity/Fragment. What is still required is to add our <code>AwesomeLibMain</code> class as an <strong>Observer</strong> for the lifecycle of the desired Activity. Turns out it is a really simple step, as can be seen below</p>

<blockquote>
<p>Note: <code>MainActivity</code> here extends <code>AppCompatActivity</code> because we are using the latest <a href="https://developer.android.com/topic/libraries/support-library/revisions.html#26-1-0">support lib v26.1.0</a>¬†, which now has <code>AppCompatActivity</code> implementing <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleOwner.html">LifecycleOwner</a> interface from <a href="https://developer.android.com/topic/libraries/architecture/index.html">Architecture Components</a>.</p>

<p><em><strong>From android official docs</strong>: <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleOwner.html">LifecycleOwner</a> is a single method interface that denotes that the class has a <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html">Lifecycle</a>. It has one method, <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleOwner.html#getLifecycle%28%29"><code>getLifecycle()</code></a>, which must be implemented by the class.</em></p>

<p>If you are using a version of support lib below <code>v26.1.0</code> then <code>MainActivity</code> will need to extend <code>LifecycleActivity</code> and app module‚Äôs <code>build.gradle</code> will need to include to get access to <code>LifecycleActivity</code>.</p>

<p><code>implementation &quot;android.arch.lifecycle:extensions:1.0.0-beta1</code></p>
</blockquote>

<script src="https://gist.github.com/nisrulz/4971c0496031322336d9ed9e0b5224d4.js"></script>

<p>so you basically needed to add it as an <strong>Observer</strong> for lifecycle in <code>onCreate()</code> of Activity via</p>

<pre><code class="language-java">// Add Lifecycle Observer
getLifecycle().addObserver(AwesomeLibMain.getInstance());
</code></pre>

<p>‚Ä¶and then remove the Observer for lifecycle in onDestroy() of Activity via</p>

<pre><code class="language-java">// Remove Lifecycle Observer
getLifecycle().removeObserver(AwesomeLibMain.getInstance());
</code></pre>

<p>Thats it! No, really thats all there is. You have successfully integrated lifecycle arch components in your <code>awesomelib</code> and now it is observing Activity Lifecycle events and triggering the right methods at the right time, without requiring the <code>app</code> developer to worry about anything.</p>

<blockquote>
<p>Note: This is the only step <code>app</code> developer needs to do when going to use your android library in terms of integrating your library code in the activity, apart from adding it in the <code>build.gradle</code> dependency section. All methods will be triggered automatically when a said lifecycle event state is reached during the execution of the Activity/Fragment.</p>
</blockquote>

<p>What I have tried to explain here is more like a proof of concept, I am sure one can very easily implement it in an existing android library code and make use of the benefits lifecycle arch components bring along.</p>

<p>For people worried about adding a lot of method counts to their app, below is a snapshot of method counts (used <a href="https://github.com/google/android-classyshark">Classyshark</a> Tool) for the used arch component libs, <code>awesomelib</code> module and the sample app itself (from the sample <code>app</code> I have linked below)</p>

<p><img src="https://crushingcode.github.io/images/posts/is-your-android-library-lifecycle-aware/p3.jpeg" alt="p3" /></p>

<p>Simple rundown shows the method count for</p>

<ul>
<li>arch component libs‚Äì<strong>122 methods</strong></li>
<li>awesomelib-<strong>5 methods</strong></li>
</ul>

<p>So as you can see they are pretty light in terms of adding method count. Support library is part of the app module and something usually all apps nowadays have, so you are basically not shipping your android library with that. üòÖ</p>

<p>As mentioned at the start of this post, the code for above is available on github <a href="https://github.com/nisrulz/android-examples/tree/develop/LifeCycleCompForLib">here</a>.</p>

<p>If you have suggestions or maybe would like me to add something to the content here, please let me know.
Till then keep crushing code ü§ì</p>

<hr />

<blockquote>
<p>I gave a talk on this topic at <a href="http://droidcon.de/en/sessions/things-i-wish-i-knew-when-i-started-building-android-sdklibraries">Droidcon Berlin ‚Äô17</a>, checkout the slides <a href="https://speakerdeck.com/nisrulz/libraries">here</a>.This post got featured in <a href="http://androidweekly.net/issues/issue-276">Android Weekly Issue 276</a>! üòé</p>

<p>P.S. : This post is also published on <a href="https://android.jlelse.eu/is-your-android-library-lifecycle-aware-127629d32dcc">medium.</a></p>
</blockquote>

    </section>


  <footer class="post-footer">


    
    <figure class="author-image">
        <a class="img" href="https://crushingcode.github.io/" style="background-image: url(https://crushingcode.github.io/images/author.jpg)"><span class="hidden">Nishant Srivastava's Picture</span></a>
    </figure>
    

    





<section class="author">
  <h4><a href="https://crushingcode.github.io/">Nishant Srivastava</a></h4>
  
  <p>Creative sleeper. Avid dreamer.</p>
  
  <div class="author-meta">
    <span class="author-location icon-location">Vancouver, BC</span>
    <span class="author-link icon-link"><a href="http://nisrulz.com/">http://nisrulz.com/</a></span>
  </div>
</section>



    
<section class="share">
  <h4>Share this post</h4>
  <a class="icon-twitter" style="font-size: 1.4em" href="https://twitter.com/share?text=Is%20your%20Android%20Library%2c%20Lifecycle-Aware%3f&amp;url=https%3a%2f%2fcrushingcode.github.io%2fis-your-android-library-lifecycle-aware%2f"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
      <span class="hidden">Twitter</span>
  </a>
  <a class="icon-facebook" style="font-size: 1.4em" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fcrushingcode.github.io%2fis-your-android-library-lifecycle-aware%2f"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
      <span class="hidden">Facebook</span>
  </a>
  <a class="icon-google-plus" style="font-size: 1.4em" href="https://plus.google.com/share?url=https%3a%2f%2fcrushingcode.github.io%2fis-your-android-library-lifecycle-aware%2f"
     onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
      <span class="hidden">Google+</span>
  </a>
</section>



    

<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'crushingcode';
  var disqus_url = 'https:\/\/crushingcode.github.io\/is-your-android-library-lifecycle-aware\/';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




  </footer>
</article>

</main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">Crushing C.O.D.E</a> All rights reserved - Nishant Srivastava</section>
        
        <section class="poweredby">Proudly generated by <a class="icon-hugo" href="http://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/vjeantet/hugo-theme-casper">Casper</a> theme</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="https://crushingcode.github.io/js/jquery.js"></script>
    <script type="text/javascript" src="https://crushingcode.github.io/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://crushingcode.github.io/js/index.js"></script>
    
</body>
</html>

